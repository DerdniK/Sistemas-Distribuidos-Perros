version: '3.8'

services:
  # ----------------------------------------
  # 1. BASE DE DATOS (MySQL para SOAP)
  # ----------------------------------------
  lolchamps-mysql:
    image: mysql:8.0
    container_name: lolchamps-mysql-db
    environment:
      MYSQL_ROOT_PASSWORD: password123
      MYSQL_DATABASE: League_of_Legends_DB
    ports:
      - "3306:3306"
    networks:
      - champion-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-ppassword123"]
      interval: 10s
      timeout: 5s
      retries: 5
    volumes:
      - mysql_data:/var/lib/mysql

  # ----------------------------------------
  # 2. CACHE (Redis)
  # ----------------------------------------
  redis:
    image: redis:7-alpine
    container_name: redis-cache
    ports:
      - "6379:6379"
    networks:
      - champion-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ----------------------------------------
  # 3. API SOAP (Java)
  # ----------------------------------------
  soap-service:
    build:
      context: ./Lol-Champs-Api
      dockerfile: Dockerfile
    container_name: soap-service
    environment:
      - MYSQL_HOST=lolchamps-mysql
      - MYSQL_USER=root
      - MYSQL_PASSWORD=password123
    ports:
      - "8080:8080"
    networks:
      - champion-network
    depends_on:
      lolchamps-mysql:
        condition: service_healthy

  # ----------------------------------------
  # 4. API gRPC (Go)
  # ----------------------------------------
  grpc-server:
    build:
      context: ./LolEvokersGRPC 
      dockerfile: Dockerfile
    container_name: EvokersGRPC
    ports:
      - "50051:50051"
    volumes:
      - ./data_grpc:/data:Z 
    environment:
      - CGO_ENABLED=1
    networks:
      - champion-network
    restart: always

  # ----------------------------------------
  # 5. HYDRA & AUTH (CORREGIDO)
  # ----------------------------------------
  
  hydra-postgres:
    image: postgres:11.8
    container_name: hydra-postgres
    environment:
      - POSTGRES_USER=hydra
      - POSTGRES_PASSWORD=secret
      - POSTGRES_DB=hydra
    networks:
      - champion-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U hydra"]
      interval: 10s
      timeout: 5s
      retries: 5

  # MIGRACIÃ“N
  hydra-migrate:
    image: oryd/hydra:v1.10.6
    container_name: hydra-migrate
    command: migrate sql -e --yes
    environment:
      - DSN=postgres://hydra:secret@hydra-postgres:5432/hydra?sslmode=disable
    networks:
      - champion-network
    depends_on:
      hydra-postgres:
        condition: service_healthy
    restart: "no"

  # SERVIDOR HYDRA
  hydra:
    image: oryd/hydra:v1.10.6
    container_name: hydra
    command: serve all --dangerous-force-http
    environment:
      - DSN=postgres://hydra:secret@hydra-postgres:5432/hydra?sslmode=disable
      - URLS_SELF_ISSUER=http://hydra:4444/
      - URLS_CONSENT=http://127.0.0.1:9020/consent
      - URLS_LOGIN=http://127.0.0.1:9020/login
      - SECRETS_SYSTEM=this_is_my_super_secret_password_1234
      - STRATEGIES_ACCESS_TOKEN=jwt
    ports:
      - "4444:4444" 
      - "4445:4445" 
    networks:
      - champion-network
    depends_on:
      hydra-postgres:
        condition: service_healthy
    restart: on-failure:10

  # ----------------------------------------
  # 6. API REST (Spring Boot)
  # ----------------------------------------
  rest-service:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: rest-service
    environment:
      - MYSQL_HOST=lolchamps-mysql
      - MYSQL_USER=root
      - MYSQL_PASSWORD=password123
      - REDIS_HOST=redis
      - SOAP_URL=http://soap-service:8080/ws
      - GRPC_ADDRESS=static://grpc-server:50051
      - SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_ISSUER_URI=http://hydra:4444/
      - LOGGING_LEVEL_ORG_SPRINGFRAMEWORK_SECURITY=DEBUG
      - LOGGING_LEVEL_ORG_SPRINGFRAMEWORK_SECURITY_OAUTH2=DEBUG
      - LOGGING_LEVEL_ORG_SPRINGFRAMEWORK_WEB=DEBUG
    ports:
      - "8081:8081"
    networks:
      - champion-network
    depends_on:
      lolchamps-mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
      soap-service:
        condition: service_started
      grpc-server: 
        condition: service_started
      hydra:
        condition: service_started
    restart: on-failure:5

networks:
  champion-network:
    driver: bridge

volumes:
  mysql_data:
    driver: local